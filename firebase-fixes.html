<!-- Firebase App Bug Fixes -->
<!-- Add these corrected JavaScript functions to your existing HTML app -->

<script>
// =================== PROFILE PERSISTENCE FIX ===================

// Fixed saveProfile function - stores data in Firestore with merge: true
async function saveProfile() {
    try {
        const user = auth.currentUser;
        if (!user) {
            alert('Please log in first');
            return;
        }

        // Get form data
        const displayName = document.getElementById('displayName').value;
        const email = document.getElementById('email').value;
        const bio = document.getElementById('bio').value;

        // Save to Firestore with merge: true to preserve existing data
        await db.collection('users').doc(user.uid).set({
            displayName: displayName,
            email: email,
            bio: bio,
            uid: user.uid,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        alert('Profile saved successfully!');
        console.log('Profile data saved to Firestore');
    } catch (error) {
        console.error('Error saving profile:', error);
        alert('Error saving profile: ' + error.message);
    }
}

// Fixed loadProfile function - fetches data from Firestore on login
async function loadProfile() {
    try {
        const user = auth.currentUser;
        if (!user) return;

        // Fetch user profile from Firestore
        const doc = await db.collection('users').doc(user.uid).get();
        
        if (doc.exists) {
            const userData = doc.data();
            
            // Populate form fields with stored data
            if (document.getElementById('displayName')) {
                document.getElementById('displayName').value = userData.displayName || '';
            }
            if (document.getElementById('email')) {
                document.getElementById('email').value = userData.email || user.email || '';
            }
            if (document.getElementById('bio')) {
                document.getElementById('bio').value = userData.bio || '';
            }
            
            console.log('Profile data loaded from Firestore');
        } else {
            // If no profile exists, create one with basic info
            await db.collection('users').doc(user.uid).set({
                uid: user.uid,
                email: user.email,
                displayName: user.displayName || '',
                bio: '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        }
    } catch (error) {
        console.error('Error loading profile:', error);
    }
}

// =================== FRIEND REQUEST DUPLICATE FIX ===================

// Fixed sendFriendRequest function - checks for existing requests
async function sendFriendRequest(receiverId) {
    try {
        const user = auth.currentUser;
        if (!user) {
            alert('Please log in first');
            return;
        }

        const senderId = user.uid;
        
        // Check if request already exists between these users
        const existingRequest = await db.collection('friendRequests')
            .where('senderId', '==', senderId)
            .where('receiverId', '==', receiverId)
            .get();

        // Also check reverse direction (if receiver already sent request to sender)
        const reverseRequest = await db.collection('friendRequests')
            .where('senderId', '==', receiverId)
            .where('receiverId', '==', senderId)
            .get();

        if (!existingRequest.empty || !reverseRequest.empty) {
            alert('Friend request already sent.');
            return;
        }

        // Create new friend request
        await db.collection('friendRequests').add({
            senderId: senderId,
            receiverId: receiverId,
            status: 'pending',
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert('Friend request sent successfully!');
        console.log('Friend request sent to:', receiverId);
        
        // Refresh the UI
        loadFriendRequests();
        
    } catch (error) {
        console.error('Error sending friend request:', error);
        alert('Error sending friend request: ' + error.message);
    }
}

// =================== AUTH STATE LISTENER FIX ===================

// Fixed auth state listener - loads profile data on login
firebase.auth().onAuthStateChanged(async function(user) {
    if (user) {
        console.log('User logged in:', user.uid);
        
        // Load profile data when user logs in
        await loadProfile();
        
        // Load friend requests
        loadFriendRequests();
        
        // Show authenticated content
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
    } else {
        console.log('User logged out');
        
        // Clear form fields on logout
        const fields = ['displayName', 'email', 'bio'];
        fields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.value = '';
        });
        
        // Show login form
        document.getElementById('authSection').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
    }
});

// =================== ENHANCED USER SEARCH FIX ===================

// Fixed searchUsers function - searches in Firestore users collection
async function searchUsers() {
    try {
        const query = document.getElementById('searchInput').value.trim();
        if (!query) {
            document.getElementById('searchResults').innerHTML = '';
            return;
        }

        const currentUser = auth.currentUser;
        if (!currentUser) return;

        // Search users by email or displayName in Firestore
        const emailQuery = await db.collection('users')
            .where('email', '>=', query)
            .where('email', '<=', query + '\uf8ff')
            .get();

        const nameQuery = await db.collection('users')
            .where('displayName', '>=', query)
            .where('displayName', '<=', query + '\uf8ff')
            .get();

        const results = [];
        const userIds = new Set();

        // Combine results and remove duplicates
        emailQuery.forEach(doc => {
            const userData = doc.data();
            if (userData.uid !== currentUser.uid && !userIds.has(userData.uid)) {
                results.push(userData);
                userIds.add(userData.uid);
            }
        });

        nameQuery.forEach(doc => {
            const userData = doc.data();
            if (userData.uid !== currentUser.uid && !userIds.has(userData.uid)) {
                results.push(userData);
                userIds.add(userData.uid);
            }
        });

        displaySearchResults(results);

    } catch (error) {
        console.error('Error searching users:', error);
        alert('Error searching users: ' + error.message);
    }
}

// Enhanced display function for search results
function displaySearchResults(users) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (users.length === 0) {
        resultsDiv.innerHTML = '<p>No users found.</p>';
        return;
    }

    let html = '<div class="user-results">';
    users.forEach(user => {
        html += `
            <div class="user-item">
                <div class="user-info">
                    <strong>${user.displayName || 'No name'}</strong>
                    <br><small>${user.email}</small>
                    ${user.bio ? `<br><em>${user.bio}</em>` : ''}
                </div>
                <button onclick="sendFriendRequest('${user.uid}')" class="btn-send-request">
                    Send Request
                </button>
            </div>
        `;
    });
    html += '</div>';
    
    resultsDiv.innerHTML = html;
}

</script>

<!-- 
INTEGRATION INSTRUCTIONS:

1. Replace the existing saveProfile() function with the fixed version above
2. Replace the existing sendFriendRequest() function with the fixed version above  
3. Replace the existing auth state listener with the fixed version above
4. Replace the existing searchUsers() function with the enhanced version above
5. Make sure your existing HTML form has the correct input IDs: 'displayName', 'email', 'bio'

KEY FIXES IMPLEMENTED:

✅ Profile Persistence:
   - saveProfile() now uses Firestore with { merge: true }
   - loadProfile() fetches data from Firestore on login
   - Auth listener automatically loads profile data

✅ Friend Request Duplicates:
   - sendFriendRequest() checks for existing requests in both directions
   - Shows "Friend request already sent" alert for duplicates
   - Only creates new request if none exists

✅ Enhanced Error Handling:
   - Proper try-catch blocks with user-friendly error messages
   - Console logging for debugging
   - Input validation and user feedback

-->